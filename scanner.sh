#!/bin/bash

# Check if IP Address is passed

if [ $# -eq 0 ]; then
    echo "Invalid Syntax"
    echo "./scanner.sh [target_ip]"
    
    exit 1
fi

# Colors
GREEN="\033[0;32m"
BLUE="\033[0;34m"
YELLOW="\033[1;33m"
NO_COLOR="\033[0m"

# Target IP
target_ip=$1

echo -e "${BLUE}[!] Running rustscan to get open ports${NO_COLOR}"

rustscan_results=$(rustscan -a $target_ip -r 1-65535)

# Extracting Open Ports from Rustscan Results
open_ports_lines=$(echo "$rustscan_results" | grep "Discovered open port")

ports=$(echo "$open_ports_lines" | cut -d " " -f4- | rev | cut -d " " -f3- | rev)

open_ports=($ports)

# Display Open Ports
echo -e "${YELLOW}[+] Open Ports Identified:${NO_COLOR}" 
printf "${GREEN}%s\n${NO_COLOR}" "${open_ports[@]}"

# Convert Open Ports into a String for Nmap
ports_for_nmap=$(echo "$ports" | rev | cut -c5- | rev)

ports_for_nmap=($ports_for_nmap)

ports_for_nmap=$(printf "%s," "${ports_for_nmap[@]}")

echo -e "${BLUE}[!] Running Nmap for open ports${NO_COLOR}"

# Run Nmap on open ports identified by rustscan
sudo nmap -A -T4 -sS -p$ports_for_nmap $target_ip $2
